"use strict";var $=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var O=(i,t)=>{for(var o in t)$(i,o,{get:t[o],enumerable:!0})},Q=(i,t,o,p)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of q(t))!H.call(i,d)&&d!==o&&$(i,d,{get:()=>t[d],enumerable:!(p=V(t,d))||p.enumerable});return i};var X=i=>Q($({},"__esModule",{value:!0}),i);var re={};O(re,{default:()=>D});module.exports=X(re);var s=require("@raycast/api"),E=require("child_process"),m=require("react");var j=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],J=["B","kiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],ee=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],te=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],F=(i,t,o)=>{let p=i;return typeof t=="string"||Array.isArray(t)?p=i.toLocaleString(t,o):(t===!0||o!==void 0)&&(p=i.toLocaleString(void 0,o)),p};function T(i,t){if(!Number.isFinite(i))throw new TypeError(`Expected a finite number, got ${typeof i}: ${i}`);t={bits:!1,binary:!1,space:!0,...t};let o=t.bits?t.binary?te:ee:t.binary?J:j,p=t.space?" ":"";if(t.signed&&i===0)return` 0${p}${o[0]}`;let d=i<0,y=d?"-":t.signed?"+":"";d&&(i=-i);let l;if(t.minimumFractionDigits!==void 0&&(l={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(l={maximumFractionDigits:t.maximumFractionDigits,...l}),i<1){let A=F(i,t.locale,l);return y+A+p+o[0]}let S=Math.min(Math.floor(t.binary?Math.log(i)/Math.log(1024):Math.log10(i)/3),o.length-1);i/=(t.binary?1024:1e3)**S,l||(i=i.toPrecision(3));let M=F(Number(i),t.locale,l),x=o[S];return y+M+p+x}var I=require("react"),ie=()=>{};function se(i,t){let o=(0,I.useRef)(ie);(0,I.useEffect)(()=>{o.current=i},[i]),(0,I.useEffect)(()=>{if(o.current(),(t??0)>0){let d=Math.max(t??0,1e3),y=setInterval(()=>o.current(),d);return()=>clearInterval(y)}},[t])}var k=se;var f=require("react/jsx-runtime");function D(){let[i,t]=(0,m.useState)([]),[o,p]=(0,m.useState)([]),[d,y]=(0,m.useState)(void 0),l=(0,s.getPreferenceValues)(),S=l.shouldSearchInPaths??!1,M=l.shouldSearchInPid??!1,x=l.shouldPrioritizeAppsWhenFiltering??!1,A=l.shouldShowPID??!1,L=l.shouldShowPath??!1,v=+l.refreshDuration,[P,U]=(0,m.useState)(l.sortByMem??!1),[N,R]=(0,m.useState)(l.aggregateApps??!1),C=()=>{(0,E.exec)("ps -eo pid,ppid,pcpu,rss,comm",(e,a)=>{if(e!=null)return;let c=a.split(`
`).map(g=>{let b=["","","","","",""],B=/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/,[,r,u,n,h,w]=g.match(B)??b,W=w.match(/[^/]*[^/]*$/i)?.[0]??"",z=w.includes(".prefPane"),K=w.includes(".app/");return{id:parseInt(r),pid:parseInt(u),cpu:parseFloat(n),mem:parseInt(h),type:z?"prefPane":K?"app":"binary",path:w,processName:W}}).filter(g=>g.processName!=="");t(c)})};k(C,v),(0,m.useEffect)(()=>{let e=i;N&&(e=_(e)),e.sort((a,c)=>P?a.mem>c.mem?-1:1:a.cpu>c.cpu?-1:1),p(e)},[i,P,N]);let Y=e=>e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns",G=e=>{(0,E.exec)(`kill -9 ${e.id}`),t(o.filter(a=>a.id!==e.id)),(0,s.clearSearchBar)({forceScrollToTop:!0}),(0,s.showHUD)(`\u2705 Killed ${e.processName==="-"?`process ${e.id}`:e.processName}`)},Z=e=>{let a=[];return e.type==="aggregatedApp"&&e.appName!=null&&a.push(e.appName),A&&a.push(e.id.toString()),L&&a.push(e.path),a.join(" - ")},_=e=>{let a=Array(),c=new Map;c.set(1,{process:{id:1},childNodes:[]});let g=Array();e.forEach(r=>{if(r.type==="app"){g.push(r.id);let u=c.get(r.id);u==null?(u={process:r,childNodes:[]},c.set(r.id,u)):u.process=r;let n=c.get(r.pid);if(n==null)n={process:void 0,childNodes:[u]},c.set(r.pid,n);else if(n.process==null)n.childNodes.push(u);else{let h;for(;n?.process!=null&&n.process.pid!==1&&(h=c.get(n.process.pid))!=null;)n=h;n?.childNodes.push(u)}n.process?.id!==1&&(n.childNodes=n.childNodes.concat(u.childNodes),u.childNodes=[])}else a.push(r)});let b=c.get(1)?.childNodes,B=Array();return b?.forEach(r=>{if(r.process==null)return;B.push(r.process.id);let u=r.childNodes.map(n=>n.process?.id).filter(n=>n!=null);B=B.concat(u),a.push({id:r.process.id,pid:r.process.pid,cpu:(r.childNodes?.reduce((n,h)=>n+(h.process?.cpu??0),0)??0)+r.process.cpu,mem:(r.childNodes?.reduce((n,h)=>n+(h.process?.mem??0),0)??0)+r.process.mem,type:"aggregatedApp",path:r.process.path,processName:r.process.processName,appName:r.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),a};return(0,f.jsx)(s.List,{isLoading:o.length===0,searchBarPlaceholder:"Filter by name...",onSearchTextChange:e=>y(e),children:o.filter(e=>{if(d===""||d==null)return!0;let a=e.processName.toLowerCase().includes(d.toLowerCase()),c=S&&e.path.toLowerCase().match(new RegExp(`.+${d}.*\\.[app|framework|prefpane]`,"ig"))!=null,g=M&&e.id.toString().includes(d),b=e.type==="aggregatedApp"&&e.appName?.toLowerCase().includes(d.toLowerCase());return a||c||g||b}).sort((e,a)=>{if(d!=null&&x){let c=["app","aggregatedApp"];if(c.includes(e.type)&&!c.includes(a.type))return-1;if(!c.includes(e.type)&&c.includes(a.type))return 1}return 0}).map((e,a)=>{let c=Y(e);return(0,f.jsx)(s.List.Item,{title:e.processName,subtitle:Z(e),icon:c,accessories:[{text:P?`${e.cpu.toFixed(2)}% ${T(e.mem*1024)}`:`${T(e.mem*1024)} ${e.cpu.toFixed(2)}%`}],actions:(0,f.jsxs)(s.ActionPanel,{children:[(0,f.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>G(e)}),e.path==null?null:(0,f.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:e.path}),(0,f.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>C()}),(0,f.jsx)(s.Action,{title:`Sort by ${P?"CPU":"memory"} usage`,icon:s.Icon.Filter,shortcut:{key:"tab",modifiers:[]},onAction:()=>{U(!P),(0,s.showToast)({title:`Sorted by ${P?"CPU":"memory"} usage`})}}),(0,f.jsx)(s.Action,{title:`${N?"Dis":"En"}able aggregating apps`,icon:s.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{R(!N),(0,s.showToast)({title:`${N?"Dis":"En"}abled aggregating apps`})}})]})},a)})})}
